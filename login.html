<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login - Journey Plan Dashboard</title>
    <link rel="icon" href="/128x128@2x.png" type="image/x-icon" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "Segoe UI", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .login-container {
        width: 100%;
        max-width: 400px;
        padding: 40px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      }

      h1 {
        margin-bottom: 30px;
        font-size: 28px;
        color: #1f2147;
        text-align: center;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
        font-weight: 600;
        color: #2a2a64;
      }

      input {
        width: 100%;
        padding: 12px 16px;
        font-size: 15px;
        border: 1px solid rgba(48, 43, 184, 0.2);
        border-radius: 8px;
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }

      button {
        width: 100%;
        padding: 14px;
        font-size: 16px;
        font-weight: 600;
        color: white;
        background: linear-gradient(135deg, #667eea, #764ba2);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
      }

      button:active {
        transform: translateY(0);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      #status {
        margin-top: 16px;
        padding: 10px;
        border-radius: 6px;
        font-size: 14px;
        text-align: center;
        display: none;
      }

      #status.error {
        display: block;
        background: #fee;
        color: #c00;
        border: 1px solid #fcc;
      }

      #status.success {
        display: block;
        background: #efe;
        color: #0a0;
        border: 1px solid #cfc;
      }

      .back-link {
        margin-top: 20px;
        text-align: center;
      }

      .back-link a {
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
      }

      .back-link a:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <h1>üîê Dashboard Login</h1>

      <form id="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input
            type="text"
            id="username"
            name="username"
            required
            autocomplete="username"
            placeholder="Enter your username"
          />
        </div>

        <div class="form-group">
          <label for="password">Password</label>
          <input
            type="password"
            id="password"
            name="password"
            required
            autocomplete="current-password"
            placeholder="Enter your password"
          />
        </div>

        <button type="submit" id="login-btn">Login</button>

        <div id="status"></div>
      </form>

      <!-- <div class="back-link">
        <a href="index.html">‚Üê Back to Journey Plan</a>
      </div> -->
    </div>

    <script type="module">
      const REMOTE_API_BASE = "";
      const LOCAL_HOSTS = ["localhost", "127.0.0.1"];
      const API_ORIGIN = LOCAL_HOSTS.includes(window.location.hostname)
        ? ""
        : REMOTE_API_BASE || window.location.origin;
      window.API_BASE = API_ORIGIN;

      const AUTH_STORAGE_KEY = "currentUser";
      const form = document.getElementById("login-form");
      const statusEl = document.getElementById("status");
      const loginBtn = document.getElementById("login-btn");

      function showStatus(message, type = "error") {
        statusEl.textContent = message;
        statusEl.className = type;
      }

      async function fetchSessionUser() {
        try {
          const response = await fetch(`${API_ORIGIN}/api/auth/me`, {
            credentials: "include",
          });
          if (!response.ok) {
            throw new Error("No active session");
          }
          const { user } = await response.json();
          return user || null;
        } catch {
          return null;
        }
      }

      const existingUser = await fetchSessionUser();
      if (existingUser) {
        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(existingUser));
        if (existingUser.must_change_password) {
          window.location.href = "change-password.html";
        } else {
          const target =
            existingUser.role === "admin" ? "dashboard.html" : "index.html";
          window.location.href = target;
        }
      } else {
        localStorage.removeItem(AUTH_STORAGE_KEY);
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const password = document.getElementById("password").value;

        if (!username || !password) {
          showStatus("Please enter username and password", "error");
          return;
        }

        loginBtn.disabled = true;
        showStatus("Logging in...", "success");

        try {
          const response = await fetch(
            `${window.API_BASE || ""}/api/auth/login`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ username, password }),
            }
          );

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Login failed");
          }

          localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(data.user));

          showStatus("Login successful! Redirecting...", "success");

          setTimeout(() => {
            if (data.user.must_change_password) {
              window.location.href = "change-password.html";
            } else if (data.user.role === "admin") {
              window.location.href = "dashboard.html";
            } else {
              window.location.href = "index.html";
            }
          }, 400);
        } catch (error) {
          console.error("Login error:", error);
          localStorage.removeItem(AUTH_STORAGE_KEY);
          showStatus(error.message || "Login failed", "error");
        } finally {
          loginBtn.disabled = false;
        }
      });

      setTimeout(() => {
        const hint = document.createElement("div");
        hint.style.cssText =
          "margin-top: 20px; padding: 12px; background: #f0f4ff; border-radius: 6px; font-size: 13px; color: #666; text-align: center;";
        hint.innerHTML =
          "<strong>Admin:</strong> admin / admin123<br><strong>Employee:</strong> employee / employee123<br><small>(Change passwords after first login)</small>";
        form.appendChild(hint);
      }, 1000);
    </script>
  </body>
</html>
