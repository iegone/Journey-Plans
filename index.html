<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Journey Plan</title>
    <link rel="icon" href="/128x128@2x.png" type="image/x-icon" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="sidebar">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
        "
      >
        <h2 style="margin: 0; font-size: 18px">Journey Plan</h2>
        <div style="display: flex; gap: 8px; align-items: center">
          <span id="current-user" style="font-size: 12px; color: #666"></span>
          <button
            class="btn btn-secondary btn-small"
            id="logout-btn"
            style="padding: 4px 8px; font-size: 11px"
          >
            Logout
          </button>
        </div>
      </div>
      <div
        id="approval-banner"
        style="display: none; margin: 12px 0; padding: 12px; background: #fff4e5; border: 1px solid #fcd34d; border-radius: 8px; color: #b45309; font-size: 12px; line-height: 1.4;"
      >
        Admin approval required. Contact your administrator to make changes or
        print.
      </div>
      <div style="position: relative">
        <label for="load-journey-search">Load Saved Journey</label>
        <input
          type="text"
          id="load-journey-search"
          placeholder="Type to search: #85, driver, location..."
          autocomplete="off"
        />
        <div
          id="journey-suggestions"
          style="
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid rgba(48, 43, 184, 0.2);
            border-radius: 8px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            margin-top: 4px;
          "
        ></div>
      </div>
      <div
        style="
          border-top: 2px solid rgba(48, 43, 184, 0.2);
          padding-top: 16px;
          margin-top: 8px;
        "
      >
        <label for="departure-date">Departure date</label>
        <input type="date" id="departure-date" />
      </div>
      <div>
        <label for="vehicle-number">Vehicle Number</label>
        <select id="vehicle-number" data-placeholder="Select driver">
          <option value="">select vehicle</option>
          <option value="4972 YW">Unit 1</option>
          <option value="575 BA">Unit 2</option>
          <option value="2111RK">Unit 3</option>
          <option value="6354 RH">Unit 4</option>
          <option value="3267 HW">Unit 5</option>
          <option value="3950 DA">Pickup 1</option>
          <option value="171 MB">Pickup 2</option>
          <option value="9689 HW">Pickup 3</option>
        </select>
      </div>
      <div>
        <label for="driver-name">Driver Name</label>
        <select id="driver-name" data-placeholder="Select driver">
          <option value="">Select driver</option>
          <option
            data-code="VOS-001"
            data-gsm="9070 7038"
            value="Mohamed Al Mayahi"
          >
            Mohamed Al Mayahi
          </option>
          <option
            data-code="VOS-0014"
            data-gsm="9796 9572"
            value="Hamed Al Raabi"
          >
            Hamed Al Naabi
          </option>
          <option data-code="VOS-0029" data-gsm="9206 2338" value="Ahmed Salah">
            Ahmed Salah
          </option>
          <option
            data-code="VOS-003"
            data-gsm="9633 5565"
            value="Mohammed Sulaiman"
          >
            Mohammed Sulaiman
          </option>
          <option
            data-code="VOS-009"
            data-gsm="9818 0866"
            value="Haitham Al Hadi"
          >
            Haitham Al Hadi
          </option>
          <option
            data-code="VOS-0018"
            data-gsm="9231 4855"
            value="Waleed Al Balushi"
          >
            Waleed Al Balushi
          </option>
          <option
            data-code="VOS-0024"
            data-gsm="9796 9571"
            value="Mojaled Ahmed"
          >
            Mojaled Ahmed
          </option>
          <option
            data-code="VOS-0004"
            data-gsm="9988 7044"
            value="Abdu Aziz Salim"
          >
            Abdu Aziz Salim
          </option>
          <option
            data-code="VOS-007"
            data-gsm="9944 3307"
            value="Ali Said Al Mulhairhi"
          >
            Ali Said Al Mulhairhi
          </option>
          <option
            data-code="VOS-0025"
            data-gsm="9232 4405"
            value="Haitham Al Rajahi"
          >
            Haitham Al Rajahi
          </option>
          <option data-code="VOS-0028" data-gsm="9512 3881" value="Shaik Ali">
            Shaik Ali
          </option>
          <option
            data-code="VOS-0013"
            data-gsm="9553 5327"
            value="Khalid Al Sharji"
          >
            Khalid Al Sharji
          </option>
          <option
            data-code="VOS-0030"
            data-gsm="9945 4912"
            value="Zakarya Yahya"
          >
            Zakarya Yahya
          </option>
        </select>
      </div>
      <div style="display: none">
        <label for="Passenger-name">Passenger Name</label>
        <select id="Passenger-name">
          <option value="">Select passenger</option>
          <option
            data-code="VOS-001"
            data-gsm="9070 7038"
            value="Mohamed Al Mayahi"
          >
            Mohamed Al Mayahi
          </option>
          <option
            data-code="VOS-0014"
            data-gsm="9796 9572"
            value="Hamed Al Raabi"
          >
            Hamed Al Naabi
          </option>
          <option data-code="VOS-0029" data-gsm="9206 2338" value="Ahmed Salah">
            Ahmed Salah
          </option>
          <option
            data-code="VOS-003"
            data-gsm="9633 5565"
            value="Mohammed Sulaiman"
          >
            Mohammed Sulaiman
          </option>
          <option
            data-code="VOS-009"
            data-gsm="9818 0866"
            value="Haitham Al Hadi"
          >
            Haitham Al Hadi
          </option>
          <option
            data-code="VOS-0018"
            data-gsm="9231 4855"
            value="Waleed Al Balushi"
          >
            Waleed Al Balushi
          </option>
          <option
            data-code="VOS-0024"
            data-gsm="9796 9571"
            value="Mojaled Ahmed"
          >
            Mojaled Ahmed
          </option>
          <option
            data-code="VOS-0004"
            data-gsm="9988 7044"
            value="Abdu Aziz Salim"
          >
            Abdu Aziz Salim
          </option>
          <option
            data-code="VOS-007"
            data-gsm="9944 3307"
            value="Ali Said Al Mulhairhi"
          >
            Ali Said Al Mulhairhi
          </option>
          <option
            data-code="VOS-0025"
            data-gsm="9232 4405"
            value="Haitham Al Rajahi"
          >
            Haitham Al Rajahi
          </option>
          <option data-code="VOS-0028" data-gsm="9512 3881" value="Shaik Ali">
            Shaik Ali
          </option>
          <option
            data-code="VOS-0013"
            data-gsm="9553 5327"
            value="Khalid Al Sharji"
          >
            Khalid Al Sharji
          </option>
          <option
            data-code="VOS-0030"
            data-gsm="9945 4912"
            value="Zakarya Yahya"
          >
            Zakarya Yahya
          </option>
        </select>
      </div>
      <div style="display: none">
        <label for="Passenger2-name">Passenger2 Name</label>
        <select id="Passenger2-name">
          <option value="">Select passenger</option>
          <option
            data-code="VOS-001"
            data-gsm="9070 7038"
            value="Mohamed Al Mayahi"
          >
            Mohamed Al Mayahi
          </option>
          <option
            data-code="VOS-0014"
            data-gsm="9796 9572"
            value="Hamed Al Raabi"
          >
            Hamed Al Naabi
          </option>
          <option data-code="VOS-0029" data-gsm="9206 2338" value="Ahmed Salah">
            Ahmed Salah
          </option>
          <option
            data-code="VOS-003"
            data-gsm="9633 5565"
            value="Mohammed Sulaiman"
          >
            Mohammed Sulaiman
          </option>
          <option
            data-code="VOS-009"
            data-gsm="9818 0866"
            value="Haitham Al Hadi"
          >
            Haitham Al Hadi
          </option>
          <option
            data-code="VOS-0018"
            data-gsm="9231 4855"
            value="Waleed Al Balushi"
          >
            Waleed Al Balushi
          </option>
          <option
            data-code="VOS-0024"
            data-gsm="9796 9571"
            value="Mojaled Ahmed"
          >
            Mojaled Ahmed
          </option>
          <option
            data-code="VOS-0004"
            data-gsm="9988 7044"
            value="Abdu Aziz Salim"
          >
            Abdu Aziz Salim
          </option>
          <option
            data-code="VOS-007"
            data-gsm="9944 3307"
            value="Ali Said Al Mulhairhi"
          >
            Ali Said Al Mulhairhi
          </option>
          <option
            data-code="VOS-0025"
            data-gsm="9232 4405"
            value="Haitham Al Rajahi"
          >
            Haitham Al Rajahi
          </option>
          <option data-code="VOS-0028" data-gsm="9512 3881" value="Shaik Ali">
            Shaik Ali
          </option>
          <option
            data-code="VOS-0013"
            data-gsm="9553 5327"
            value="Khalid Al Sharji"
          >
            Khalid Al Sharji
          </option>
          <option
            data-code="VOS-0030"
            data-gsm="9945 4912"
            value="Zakarya Yahya"
          >
            Zakarya Yahya
          </option>
        </select>
      </div>
      <div style="display: none">
        <label for="Passenger3-name">Passenger3 Name</label>
        <select id="Passenger3-name">
          <option value="">Select passenger</option>
          <option
            data-code="VOS-001"
            data-gsm="9070 7038"
            value="Mohamed Al Mayahi"
          >
            Mohamed Al Mayahi
          </option>
          <option
            data-code="VOS-0014"
            data-gsm="9796 9572"
            value="Hamed Al Raabi"
          >
            Hamed Al Naabi
          </option>
          <option data-code="VOS-0029" data-gsm="9206 2338" value="Ahmed Salah">
            Ahmed Salah
          </option>
          <option
            data-code="VOS-003"
            data-gsm="9633 5565"
            value="Mohammed Sulaiman"
          >
            Mohammed Sulaiman
          </option>
          <option
            data-code="VOS-009"
            data-gsm="9818 0866"
            value="Haitham Al Hadi"
          >
            Haitham Al Hadi
          </option>
          <option
            data-code="VOS-0018"
            data-gsm="9231 4855"
            value="Waleed Al Balushi"
          >
            Waleed Al Balushi
          </option>
          <option
            data-code="VOS-0024"
            data-gsm="9796 9571"
            value="Mojaled Ahmed"
          >
            Mojaled Ahmed
          </option>
          <option
            data-code="VOS-0004"
            data-gsm="9988 7044"
            value="Abdu Aziz Salim"
          >
            Abdu Aziz Salim
          </option>
          <option
            data-code="VOS-007"
            data-gsm="9944 3307"
            value="Ali Said Al Mulhairhi"
          >
            Ali Said Al Mulhairhi
          </option>
          <option
            data-code="VOS-0025"
            data-gsm="9232 4405"
            value="Haitham Al Rajahi"
          >
            Haitham Al Rajahi
          </option>
          <option data-code="VOS-0028" data-gsm="9512 3881" value="Shaik Ali">
            Shaik Ali
          </option>
          <option
            data-code="VOS-0013"
            data-gsm="9553 5327"
            value="Khalid Al Sharji"
          >
            Khalid Al Sharji
          </option>
          <option
            data-code="VOS-0030"
            data-gsm="9945 4912"
            value="Zakarya Yahya"
          >
            Zakarya Yahya
          </option>
        </select>
      </div>
      <div id="passengers-dynamic">
        <label>Passengers</label>
        <div
          id="passengers-container"
          style="display: flex; flex-direction: column; gap: 8px; margin: 6px 0"
        ></div>
        <button
          type="button"
          id="add-passenger-btn"
          style="
            padding: 6px 10px;
            border: 1px solid #ccc;
            background: #f8f8f8;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          + Add passenger
        </button>
      </div>

      <div>
        <label for="from-locations">From</label>
        <select id="from-locations" data-placeholder="Select location">
          <option value="">select location</option>
          <option value="ARA">ARA</option>
          <option value="MANAH">MANAH</option>
          <option value="DALEEL">DALEEL</option>
          <option value="IBRI">IBRI</option>
        </select>
        <input type="time" id="from-time" />
      </div>
      <div style="display: none">
        <label for="Resat-locations">Resat</label>
        <select id="Resat-locations" data-placeholder="Select location">
          <option value="">select location</option>
          <option value="ARA">ARA</option>
          <option value="MANAH">MANAH</option>
          <option value="DALEEL">DALEEL</option>
          <option value="IBRI">IBRI</option>
        </select>
        <input type="time" />
      </div>
      <div style="display: none">
        <label for="Resat2-locations">Resat2</label>
        <select id="Resat2-locations">
          <option value="ARA">ARA</option>
          <option value="MANAH">MANAH</option>
          <option value="DALEEL">DALEEL</option>
          <option value="IBRI">IBRI</option>
        </select>
        <input type="time" />
      </div>
      <div>
        <label for="to-locations">To</label>
        <select id="to-locations" data-placeholder="Select location">
          <option>select location</option>
          <option value="MANAH">MANAH</option>
          <option value="DALEEL">DALEEL</option>
          <option value="IBRI">IBRI</option>
          <option value="MUSCAT">MUSCAT</option>
        </select>
        <input type="time" id="to-time" />
      </div>
      <div id="rests-dynamic" style="margin-top: 10px">
        <label>Rest stops</label>
        <div
          id="rests-container"
          style="display: flex; flex-direction: column; gap: 8px; margin: 6px 0"
        ></div>
        <button
          type="button"
          id="add-rest-btn"
          style="
            padding: 6px 10px;
            border: 1px solid #ccc;
            background: #f8f8f8;
            border-radius: 6px;
            cursor: pointer;
          "
        >
          + Add rest
        </button>
      </div>
      <div class="sidebar-actions">
        <button type="button" id="save-journey-plan">Save Journey Plan</button>
        <button
          type="button"
          id="update-journey-plan"
          style="
            display: none;
            background: linear-gradient(135deg, #f59e0b, #f97316);
          "
        >
          Update Journey Plan
        </button>
        <button
          type="button"
          id="new-journey-plan"
          style="
            display: none;
            background: linear-gradient(135deg, #10b981, #059669);
          "
        >
          New Journey Plan
        </button>
        <div id="save-status" role="status" aria-live="polite"></div>
      </div>
    </div>

    <div class="main">
      <div class="page-shell">
        <div class="page">
          <p class="Journey-Plan-Number"></p>

          <p class="Departure-Date"></p>
          <p class="Vehicle-Number"></p>
          <p class="Driver-Name"></p>
          <p class="Driver-Name"></p>

          <p class="Passengers-1"><span>1.</span> <span></span></p>
          <p class="Passengers-2"><span>2.</span> <span></span></p>
          <p class="Passengers-3"><span>3.</span> <span></span></p>

          <p class="Call-Journey-Manager">97969572</p>

          <p class="Route-Place-Name-1"></p>
          <p class="Route-Place-Name-2"></p>
          <p class="Route-Place-Name-3"></p>
          <p class="Route-Place-Name-4"></p>
          <p class="Route-Place-Name-5"></p>
          <p class="Route-Place-Name-6"></p>
          <p class="Route-Place-Name-7"></p>
          <p class="Route-Place-Name-8"></p>
          <p class="Route-Place-Name-9"></p>
          <p class="Route-Place-Name-10"></p>

          <p class="Time-Arrive-Time-Depart-1">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-2">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-3">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-4">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-5">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-6">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-7">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-8">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-9">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>
          <p class="Time-Arrive-Time-Depart-10">
            <span class="time-arrive"></span><span class="time-separator"></span
            ><span class="time-depart"></span>
          </p>

          <p class="Rest-Tick-1"></p>
          <p class="Rest-Tick-2"></p>
          <p class="Rest-Tick-3"></p>
          <p class="Rest-Tick-4"></p>
          <p class="Rest-Tick-5"></p>
          <p class="Rest-Tick-6"></p>
          <p class="Rest-Tick-7"></p>
          <p class="Rest-Tick-8"></p>
          <p class="Rest-Tick-9"></p>
          <p class="Rest-Tick-10"></p>

          <img class="img-right-1" src="./right.png" alt="" />
          <img class="img-right-2" src="./right.png" alt="" />
          <img class="img-right-3" src="./right.png" alt="" />

          <img class="signature" src="signature.png" alt="" />

          <img
            class="Signature-with-name"
            src="Signature with name.png"
            alt=""
          />
          <p class="Signature-date"></p>
        </div>
      </div>
    </div>
  </body>
  <script type="module">
    const REMOTE_API_BASE = ""; // set to deployed API origin, e.g. 'https://your-api.onrender.com'
    const LOCAL_HOSTS = ["localhost", "127.0.0.1"];
    const API_ORIGIN = LOCAL_HOSTS.includes(window.location.hostname)
      ? ""
      : REMOTE_API_BASE || window.location.origin;
    window.API_BASE = API_ORIGIN;

    const AUTH_STORAGE_KEY = "currentUser";
    const DEFAULT_VEHICLE_LABELS = {
      "4972 YW": "Unit 1",
      "575 BA": "Unit 2",
      "2111RK": "Unit 3",
      "6354 RH": "Unit 4",
      "3267 HW": "Unit 5",
      "3950 DA": "Pickup 1",
      "171 MB": "Pickup 2",
      "9689 HW": "Pickup 3",
    };
    const VEHICLE_LABELS = { ...DEFAULT_VEHICLE_LABELS };
    let currentUser = null;
    let vehicleNumberSelect = null;

    function getVehicleLabel(number, fallback = "") {
      if (!number) return fallback || "";
      return VEHICLE_LABELS[number] || fallback || number;
    }

    function populateVehicleOptions(list = []) {
      if (!vehicleNumberSelect) return;

      const currentValue = vehicleNumberSelect.value;
      vehicleNumberSelect.innerHTML =
        '<option value="">select vehicle</option>';

      const source =
        Array.isArray(list) && list.length
          ? list
          : Object.entries(DEFAULT_VEHICLE_LABELS).map(
              ([number, display_name]) => ({
                number,
                display_name,
              })
            );

      const seen = new Set();
      source.forEach((item) => {
        if (!item?.number || seen.has(item.number)) return;
        const label = getVehicleLabel(
          item.number,
          item.display_name || item.number
        );
        VEHICLE_LABELS[item.number] = label;
        const opt = new Option(label, item.number);
        opt.dataset.displayName = label;
        vehicleNumberSelect.add(opt);
        seen.add(item.number);
      });

      if (currentValue && seen.has(currentValue)) {
        vehicleNumberSelect.value = currentValue;
      }
    }

    function authFetch(url, options = {}) {
      const finalOptions = { ...options, credentials: "include" };
      if (options.headers) {
        finalOptions.headers = options.headers;
      }
      return fetch(url, finalOptions);
    }

    async function ensureAuth() {
      try {
        const response = await fetch(`${API_ORIGIN}/api/auth/me`, {
          credentials: "include",
        });
        if (!response.ok) {
          throw new Error("Unauthorized");
        }
        const { user } = await response.json();
        if (!user) {
          throw new Error("Unauthorized");
        }
        localStorage.setItem(AUTH_STORAGE_KEY, JSON.stringify(user));
        return user;
      } catch (error) {
        localStorage.removeItem(AUTH_STORAGE_KEY);
        window.location.href = "login.html";
        throw error;
      }
    }

    let mustChangePassword = false;

    try {
      currentUser = await ensureAuth();
      mustChangePassword = !!currentUser?.must_change_password;
      if (mustChangePassword) {
        window.location.href = "change-password.html";
      }
    } catch (error) {
      throw error;
    }

    if (!mustChangePassword) {
    const userDisplay = document.getElementById("current-user");
    if (userDisplay && currentUser) {
      userDisplay.textContent = `👤 ${
        currentUser.full_name || currentUser.username
      }`;
    }

    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        if (!confirm("Are you sure you want to logout?")) {
          return;
        }
        try {
          await fetch(`${API_ORIGIN}/api/auth/logout`, {
            method: "POST",
            credentials: "include",
          });
        } catch (error) {
          console.warn("Logout request failed:", error);
        } finally {
          localStorage.removeItem(AUTH_STORAGE_KEY);
          window.location.href = "login.html";
        }
      });
    }

    (function () {
      const PLACEHOLDER = "";
      const REST_NAME_CHOICES = [
        "CHECKPOINT",
        "FUEL",
        "MEAL",
        "PRAYER",
        "COFFEE",
      ];
      const REST_NAME_OPTIONS_HTML = REST_NAME_CHOICES.map(
        (name) => `<option value="${name}">${name}</option>`
      ).join("");

      function displayWithPlaceholder(value) {
        return value && String(value).trim() ? String(value).trim() : "";
      }

      function selectedText(select) {
        if (!select) return "";
        const opt = select.options[select.selectedIndex];
        return opt ? opt.textContent.trim() : "";
      }

      function attachAddButton(selectId, opts = {}) {
        const sel = document.getElementById(selectId);
        if (!sel || sel.dataset.hasAddBtn) return;

        let wrapper = sel.closest(".select-with-add");
        if (!wrapper) {
          wrapper = document.createElement("div");
          wrapper.className = "select-with-add";
          const parent = sel.parentNode;
          parent.insertBefore(wrapper, sel);
          wrapper.appendChild(sel);
        }

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = opts.label || "+";
        btn.title = opts.title || "Add option";
        btn.className = "select-add-btn";

        wrapper.appendChild(btn);
        sel.dataset.hasAddBtn = "1";

        btn.addEventListener("click", async () => {
          let label = prompt(opts.prompt || "Enter new option");
          let vehiclePlate = null;
          let vehicleDisplay = null;
          if (label === null) return;
          label = String(label).trim();
          if (!label && sel.id !== "vehicle-number") return;

          // حفظ في الداتابيز حسب نوع Select
          try {
            if (sel.id === "driver-name") {
              // حفظ السائق
              const code = prompt("Driver code (optional):", "");
              const gsm = prompt("GSM number (optional):", "");

              const response = await authFetch(
                `${window.API_BASE || ""}/api/options/drivers`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    name: label,
                    code: code?.trim(),
                    gsm: gsm?.trim(),
                  }),
                }
              );

              if (response.ok) {
                const { data } = await response.json();
                MASTER_PEOPLE_OPTIONS.push({
                  value: data.name,
                  text: data.name,
                  code: data.code,
                  gsm: data.gsm,
                });
                await loadOptionsFromDB();
              } else {
                const err = await response.json().catch(() => ({}));
                alert(err.error || "Failed to save driver");
                return;
              }
            } else if (sel.id === "vehicle-number") {
              let displayName = label;
              if (!displayName) {
                displayName = prompt("Vehicle name (e.g. Unit 7)", "");
                if (displayName === null) return;
                displayName = String(displayName).trim();
              }
              let plateNumber = prompt(
                "Vehicle plate number (used as value)",
                ""
              );
              if (plateNumber === null) return;
              plateNumber = String(plateNumber).trim();
              if (!plateNumber) {
                alert("Vehicle number is required.");
                return;
              }
              if (!displayName) {
                displayName = plateNumber;
              }

              const response = await authFetch(
                `${window.API_BASE || ""}/api/options/vehicles`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    number: plateNumber,
                    displayName,
                  }),
                }
              );

              if (response.ok) {
                VEHICLE_LABELS[plateNumber] = displayName;
                vehiclePlate = plateNumber;
                vehicleDisplay = displayName;
                await loadOptionsFromDB();
                if (vehicleNumberSelect) {
                  vehicleNumberSelect.value = plateNumber;
                  vehicleNumberSelect.dispatchEvent(
                    new Event("change", { bubbles: true })
                  );
                }
              } else {
                const err = await response.json().catch(() => ({}));
                alert(err.error || "Failed to save vehicle");
                return;
              }
            } else if (
              sel.id === "from-locations" ||
              sel.id === "to-locations"
            ) {
              // حفظ المكان
              const response = await authFetch(
                `${window.API_BASE || ""}/api/options/locations`,
                {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ name: label }),
                }
              );

              if (response.ok) {
                await loadOptionsFromDB();
              } else {
                const err = await response.json().catch(() => ({}));
                alert(err.error || "Failed to save location");
                return;
              }
            }
          } catch (error) {
            console.error("Error saving option:", error);
            alert("Failed to save option to database");
            return;
          }

          let optionValue = opts.valueMapper ? opts.valueMapper(label) : label;
          let optionLabel = label;

          if (sel.id === "vehicle-number") {
            optionValue = vehiclePlate || label;
            optionLabel = vehicleDisplay || label || optionValue;
            if (optionValue) {
              VEHICLE_LABELS[optionValue] = optionLabel;
            }
          }

          const option = new Option(optionLabel, optionValue);
          sel.add(option);
          sel.value = optionValue;
          sel.dispatchEvent(new Event("change", { bubbles: true }));

          if (typeof refreshPeopleOptions === "function") {
            refreshPeopleOptions();
          }
        });
      }

      const driverSelect = document.getElementById("driver-name");
      const driverNodes = document.querySelectorAll(".Driver-Name");
      function setDriverNameOnPage(value) {
        const text = displayWithPlaceholder(value);
        driverNodes.forEach((node) => (node.textContent = text));
      }

      const journeyNumberNode = document.querySelector(".Journey-Plan-Number");
      const saveButton = document.getElementById("save-journey-plan");
      const refreshNumberButton = document.getElementById(
        "refresh-plan-number"
      );
      const saveStatusEl = document.getElementById("save-status");
      const signatureDateNode = document.querySelector(".Signature-date");
      const callManagerNode = document.querySelector(".Call-Journey-Manager");
      const departureDateInput = document.getElementById("departure-date");
      vehicleNumberSelect = document.getElementById("vehicle-number");

      let applyDriverHandler = null;
      if (driverNodes.length) {
        if (driverSelect) {
          applyDriverHandler = () => {
            const option =
              driverSelect.selectedIndex >= 0
                ? driverSelect.options[driverSelect.selectedIndex]
                : null;
            const rawValue = driverSelect.value;
            const displayName = rawValue
              ? option
                ? option.textContent
                : rawValue
              : "";
            setDriverNameOnPage(displayName);
            if (callManagerNode) {
              callManagerNode.textContent =
                option && option.dataset.gsm ? option.dataset.gsm : "";
            }
            if (typeof refreshPeopleOptions === "function") {
              refreshPeopleOptions();
            }
          };
          driverSelect.addEventListener(
            "change",
            () => applyDriverHandler && applyDriverHandler()
          );
        } else {
          setDriverNameOnPage("");
          if (callManagerNode) callManagerNode.textContent = "";
        }
      }

      function setStatus(message, tone = "default") {
        if (!saveStatusEl) return;
        saveStatusEl.textContent = message || "";
        saveStatusEl.classList.remove("error", "success");
        if (tone === "error") {
          saveStatusEl.classList.add("error");
        } else if (tone === "success") {
          saveStatusEl.classList.add("success");
        }
      }

      if (journeyNumberNode) {
        journeyNumberNode.dataset.locked = "false";
      }

      async function fetchNextJourneyPlanNumber() {
        try {
          const response = await authFetch("/api/journey-plans/next-number");
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const { nextNumber } = await response.json();
          if (
            journeyNumberNode &&
            journeyNumberNode.dataset.locked !== "true"
          ) {
            journeyNumberNode.textContent = nextNumber ?? "";
          }
          return nextNumber;
        } catch (error) {
          console.error("Failed to fetch next journey plan number", error);
          setStatus("Unable to fetch next plan number.", "error");
          return null;
        }
      }

      [
        { id: "vehicle-number", title: "Add vehicle" },
        { id: "driver-name", title: "Add driver" },
        { id: "from-locations", title: "Add origin" },
        { id: "to-locations", title: "Add destination" },
      ].forEach((cfg) => attachAddButton(cfg.id, { title: cfg.title }));

      // Utility: get the <span> that holds the passenger name for N=1..3
      function getPassengerNameSpan(n) {
        const p = document.querySelector(`.Passengers-${n}`);
        if (!p) return null;
        const spans = p.querySelectorAll("span");
        return spans.length >= 2 ? spans[1] : null;
      }

      // Set page passenger name or dashed placeholder
      function setPassengerOnPage(n, val) {
        const target = getPassengerNameSpan(n);
        if (!target) return;
        const name = displayWithPlaceholder(val);
        target.textContent = name;
      }

      // Ensure initial placeholders for all three positions
      [1, 2, 3].forEach((n) => setPassengerOnPage(n, ""));

      // Sidebar dynamic controls
      const container = document.getElementById("passengers-container");
      const addBtn = document.getElementById("add-passenger-btn");

      function parseOptionsFromSelect(select) {
        if (!select) return [];
        return Array.from(select.options).map((opt) => ({
          value: opt.value,
          text: opt.textContent,
          code: opt.dataset.code || null,
          gsm: opt.dataset.gsm || null,
        }));
      }

      let MASTER_PEOPLE_OPTIONS = parseOptionsFromSelect(driverSelect).filter(
        (opt) => opt.value
      );
      if (driverSelect && !driverSelect.dataset.placeholder) {
        driverSelect.dataset.placeholder = "Select driver";
      }

      // ===== تحميل الخيارات من الداتابيز =====
      async function loadOptionsFromDB() {
        try {
          // تحميل السائقين
          const driversRes = await authFetch(
            `${window.API_BASE || ""}/api/options/drivers`
          );
          if (driversRes.ok) {
            const { data: drivers } = await driversRes.json();
            if (drivers && drivers.length > 0) {
              MASTER_PEOPLE_OPTIONS = drivers.map((d) => ({
                value: d.name,
                text: d.name,
                code: d.code,
                gsm: d.gsm,
              }));

              // تحديث driver select
              if (driverSelect) {
                const currentValue = driverSelect.value;
                renderSelectOptions(
                  driverSelect,
                  MASTER_PEOPLE_OPTIONS,
                  currentValue
                );
              }
            }
          }

          // تحميل المركبات
          let vehiclesLoaded = false;
          try {
            const vehiclesRes = await authFetch(
              `${window.API_BASE || ""}/api/options/vehicles`
            );
            if (vehiclesRes.ok) {
              const payload = await vehiclesRes.json();
              if (payload?.data && Array.isArray(payload.data)) {
                populateVehicleOptions(payload.data);
                vehiclesLoaded = true;
              }
            }
          } catch (error) {
            console.warn("Failed to fetch vehicles:", error);
          }
          if (!vehiclesLoaded) {
            populateVehicleOptions();
          }

          // تحميل الأماكن
          const locationsRes = await authFetch(
            `${window.API_BASE || ""}/api/options/locations`
          );
          if (locationsRes.ok) {
            const { data: locations } = await locationsRes.json();
            if (locations && locations.length > 0) {
              [fromSel, toSel].forEach((select) => {
                if (!select) return;
                const currentValue = select.value;
                const firstOption = select.querySelector('option[value=""]');
                select.innerHTML = firstOption
                  ? firstOption.outerHTML
                  : '<option value="">select location</option>';
                locations.forEach((loc) => {
                  const opt = new Option(loc.name, loc.name);
                  select.add(opt);
                });
                if (currentValue) select.value = currentValue;
              });
            }
          }
        } catch (error) {
          console.error("Error loading options from DB:", error);
          populateVehicleOptions();
        }
      }

      // استدعاء التحميل عند بدء الصفحة
      loadOptionsFromDB();

      function renderSelectOptions(select, options, currentValue) {
        if (!select) return;
        const placeholder =
          select.dataset.placeholder ||
          select.getAttribute("data-placeholder") ||
          select.querySelector('option[value=""]')?.textContent ||
          "Select option";
        const chunks = [`<option value="">${placeholder}</option>`];
        options.forEach((opt) => {
          const attrs = [];
          if (opt.code) attrs.push(`data-code="${opt.code}"`);
          if (opt.gsm) attrs.push(`data-gsm="${opt.gsm}"`);
          const attrString = attrs.length ? " " + attrs.join(" ") : "";
          const selected = opt.value === currentValue ? " selected" : "";
          chunks.push(
            `<option value="${opt.value}"${attrString}${selected}>${opt.text}</option>`
          );
        });
        select.innerHTML = chunks.join("");
        if (currentValue && options.some((opt) => opt.value === currentValue)) {
          select.value = currentValue;
        } else {
          select.value = "";
        }
      }

      function getPassengerSelects() {
        return container
          ? Array.from(
              container.querySelectorAll("select[data-passenger-index]")
            )
          : [];
      }

      function refreshPeopleOptions() {
        const passengerSelects = getPassengerSelects();
        const driverValue = driverSelect ? driverSelect.value : "";
        const passengerCounts = {};
        passengerSelects.forEach((sel) => {
          const val = sel.value;
          if (val) {
            passengerCounts[val] = (passengerCounts[val] || 0) + 1;
          }
        });

        if (driverSelect) {
          const previousDriverValue = driverValue;
          const allowedForDriver = MASTER_PEOPLE_OPTIONS.filter((opt) => {
            const value = opt.value;
            if (!value) return true;
            const count = passengerCounts[value] || 0;
            if (count > 0 && value !== driverValue) {
              return false;
            }
            return true;
          });
          renderSelectOptions(
            driverSelect,
            allowedForDriver,
            previousDriverValue
          );
          if (driverSelect.value !== previousDriverValue) {
            const driverDisplay = driverSelect.value
              ? selectedText(driverSelect) || driverSelect.value
              : "";
            setDriverNameOnPage(driverDisplay);
          }
        }

        passengerSelects.forEach((sel) => {
          const currentValue = sel.value;
          const allowed = MASTER_PEOPLE_OPTIONS.filter((opt) => {
            const value = opt.value;
            if (!value) return true;
            const count = passengerCounts[value] || 0;
            if (value === driverValue) {
              return false;
            }
            if (value === currentValue) {
              return count <= 1;
            }
            return count === 0;
          });
          renderSelectOptions(sel, allowed, currentValue);
          if (sel.value !== currentValue) {
            const idx = Number(sel.getAttribute("data-passenger-index"));
            if (!Number.isNaN(idx)) {
              setPassengerOnPage(idx, sel.value);
            }
          }
        });
      }

      function createPassengerField(n) {
        const wrap = document.createElement("div");
        wrap.style.display = "flex";
        wrap.style.gap = "6px";
        wrap.style.alignItems = "center";

        const label = document.createElement("label");
        label.textContent = `Passenger ${n}`;
        label.style.minWidth = "105px";

        const select = document.createElement("select");
        select.setAttribute("data-passenger-index", String(n));
        select.dataset.placeholder = "Select passenger";
        renderSelectOptions(select, MASTER_PEOPLE_OPTIONS, "");
        select.addEventListener("change", (e) => {
          const idx = Number(select.getAttribute("data-passenger-index"));
          setPassengerOnPage(idx, select.value);
          refreshPeopleOptions();
        });

        // Insert remove button after select creation, before label appended
        const del = document.createElement("button");
        del.type = "button";
        del.textContent = "×";
        del.style.cssText =
          "padding:2px 6px;border:1px solid #ccc;background:#eee;border-radius:4px;cursor:pointer;font-size:16px;line-height:1;";
        del.addEventListener("click", () => {
          wrap.remove();
          setPassengerOnPage(n, "");
          // re-enable add button if below 3
          if (
            container.querySelectorAll("select[data-passenger-index]").length <
            3
          ) {
            addBtn.style.display = "inline-block";
          }
          refreshPeopleOptions();
        });

        // Initialize page placeholder for this passenger
        setPassengerOnPage(n, "");

        wrap.appendChild(label);
        wrap.appendChild(select);
        wrap.appendChild(del);
        return wrap;
      }

      function currentCount() {
        return getPassengerSelects().length;
      }

      addBtn.addEventListener("click", () => {
        const count = currentCount();
        if (count >= 3) return; // safety
        const next = count + 1;
        container.appendChild(createPassengerField(next));
        refreshPeopleOptions();
        if (next >= 3) {
          addBtn.style.display = "none";
        }
      });

      // Optional: if you want passenger 1 field to appear immediately, uncomment next two lines
      // container.appendChild(createPassengerField(1));
      // addBtn.style.display = 'inline-block';

      // === LINK Departure Date to page ===
      if (departureDateInput) {
        const handleDepartureChange = (e) => {
          const v = e.target.value;
          const formatted = v
            ? new Date(v)
                .toLocaleDateString("en-GB", {
                  day: "2-digit",
                  month: "short",
                  year: "numeric",
                })
                .replace(/ /g, "-")
            : "";
          const t = document.querySelector(".Departure-Date");
          if (t) t.textContent = formatted;
          if (signatureDateNode) signatureDateNode.textContent = formatted;
        };
        departureDateInput.addEventListener("change", handleDepartureChange);
        handleDepartureChange({ target: departureDateInput });
      }

      // === LINK Vehicle Number to page ===
      if (vehicleNumberSelect) {
        Array.from(vehicleNumberSelect.options).forEach((opt) => {
          if (opt.value) {
            VEHICLE_LABELS[opt.value] =
              opt.textContent?.trim() || VEHICLE_LABELS[opt.value] || opt.value;
          }
        });

        const handleVehicleChange = (e) => {
          const select = e.target;
          const plate = select.value || "";
          const option = select.options[select.selectedIndex];
          const label = plate
            ? getVehicleLabel(
                plate,
                option?.textContent?.trim() || plate
              )
            : "";
          const displayText = plate || label;
          const t = document.querySelector(".Vehicle-Number");
          if (t) t.textContent = displayText;
        };
        vehicleNumberSelect.addEventListener("change", handleVehicleChange);
        handleVehicleChange({ target: vehicleNumberSelect });
      }
      // === LINK From / To to page (Route + Time) ===
      function getTimeElements(idx) {
        const node = document.querySelector(".Time-Arrive-Time-Depart-" + idx);
        if (!node) return null;
        return {
          node,
          arrive:
            node.querySelector(".time-arrive") ||
            node.querySelector("span:nth-child(1)"),
          separator: node.querySelector(".time-separator"),
          depart:
            node.querySelector(".time-depart") ||
            node.querySelector("span:nth-child(3)"),
        };
      }
      function fmtTime(v) {
        return v && String(v).trim() ? String(v).trim() : "";
      }
      function setArrive(idx, timeStr) {
        const elements = getTimeElements(idx);
        if (!elements || !elements.arrive) return;
        elements.arrive.textContent = fmtTime(timeStr);
        updateTimeSeparator(elements);
      }
      function setDepart(idx, timeStr) {
        const elements = getTimeElements(idx);
        if (!elements || !elements.depart) return;
        elements.depart.textContent = fmtTime(timeStr);
        updateTimeSeparator(elements);
      }
      function updateTimeSeparator(elements) {
        if (!elements || !elements.separator) return;
        const hasArrive = elements.arrive && elements.arrive.textContent.trim();
        const hasDepart = elements.depart && elements.depart.textContent.trim();
        elements.separator.textContent = hasArrive && hasDepart ? " - " : "";
      }
      function setRoutePlaceName(idx, val) {
        const t = document.querySelector(".Route-Place-Name-" + idx);
        if (t) t.textContent = displayWithPlaceholder(val);
      }
      function setTimeRange() {
        /* deprecated in favor of setArrive/setDepart */
      }

      const fromSel = document.getElementById("from-locations");
      const fromTime = document.getElementById("from-time");
      const toSel = document.getElementById("to-locations");
      const toTime = document.getElementById("to-time");

      function normalizeTimeValue(value) {
        return value && String(value).trim() ? value : "";
      }

      function renderFromRow() {
        setRoutePlaceName(
          1,
          selectedText(fromSel) || (fromSel ? fromSel.value : "")
        );
        const departValue = normalizeTimeValue(fromTime && fromTime.value);
        setArrive(1, departValue ? "00:00" : "");
        setDepart(1, departValue);
      }

      renderFromRow();

      if (fromSel) {
        fromSel.addEventListener("change", renderFromRow);
      }
      if (fromTime) {
        fromTime.addEventListener("change", renderFromRow);
      }
      if (toSel) {
        toSel.addEventListener("change", () => renderToRow());
      }
      if (toTime) {
        toTime.addEventListener("change", () => renderToRow());
      }

      // === Dynamic Rest stops (between From and To) ===
      function setRestTick(n, val) {
        const t = document.querySelector(".Rest-Tick-" + n);
        if (t) t.textContent = displayWithPlaceholder(val);
      }

      const restsContainer = document.getElementById("rests-container");
      const addRestBtn = document.getElementById("add-rest-btn");

      function restFields() {
        return restsContainer
          ? Array.from(restsContainer.querySelectorAll(".rest-field"))
          : [];
      }

      function currentRests() {
        return restFields().length;
      }

      function syncRestAddButton() {
        if (!addRestBtn) return;
        addRestBtn.style.display =
          currentRests() >= 8 ? "none" : "inline-block";
      }

      function hhmmToMin(v) {
        if (!v || !/^[0-2]?\d:[0-5]\d$/.test(v)) return null;
        const [h, m] = v.split(":").map(Number);
        return (h % 24) * 60 + m;
      }

      function minToHHMM(m) {
        m = Math.max(0, m | 0);
        const h = Math.floor(m / 60) % 24;
        const mm = m % 60;
        return String(h).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
      }

      function calculateRestTick(arrive, depart) {
        const a = hhmmToMin(arrive);
        const d = hhmmToMin(depart);
        if (a == null || d == null) return "";
        let diff = d - a;
        if (diff < 0) diff += 24 * 60;
        return minToHHMM(diff);
      }

      function findPersonMeta(value) {
        if (!value) return null;
        return MASTER_PEOPLE_OPTIONS.find((opt) => opt.value === value) || null;
      }

      function collectPassengersData() {
        return getPassengerSelects()
          .map((select, index) => {
            const value = select.value;
            if (!value) return null;
            const meta = findPersonMeta(value);
            return {
              order: index + 1,
              value,
              name: meta?.text || value,
              code: meta?.code || null,
              gsm: meta?.gsm || null,
            };
          })
          .filter(Boolean);
      }

      function buildRouteSnapshot() {
        const rows = [];
        for (let idx = 1; idx <= 10; idx++) {
          const placeNode = document.querySelector(`.Route-Place-Name-${idx}`);
          const restTickNode = document.querySelector(`.Rest-Tick-${idx}`);
          const time = getTimeElements(idx);
          rows.push({
            row: idx,
            place_name: placeNode ? placeNode.textContent.trim() : "",
            arrive: time && time.arrive ? time.arrive.textContent.trim() : "",
            depart: time && time.depart ? time.depart.textContent.trim() : "",
            rest_tick: restTickNode ? restTickNode.textContent.trim() : "",
          });
        }
        return rows;
      }

      function collectRestStopsData() {
        return restFields().map((field) => {
          const slot = Number(field.dataset.restSlot);
          const nameSel = field.querySelector("select[data-rest-name]");
          const arriveInput = field.querySelector("input[data-rest-arrive]");
          const departInput = field.querySelector("input[data-rest-depart]");
          const arrive = arriveInput ? arriveInput.value : "";
          const depart = departInput ? departInput.value : "";
          const name = nameSel ? selectedText(nameSel) || nameSel.value : "";
          const trimmedName = name && name.trim() ? name.trim() : null;
          return {
            order: slot - 1,
            table_row: slot,
            name: trimmedName,
            arrive_time: arrive,
            depart_time: depart,
            duration: calculateRestTick(arrive, depart),
          };
        });
      }

      function collectJourneyPlanData() {
        const passengers = collectPassengersData();
        const restStops = collectRestStopsData();
        const routeRows = buildRouteSnapshot();
        const numberHint = journeyNumberNode
          ? journeyNumberNode.textContent.trim()
          : null;
        const driverValue = driverSelect ? driverSelect.value : "";
        const driverMeta = findPersonMeta(driverValue);
        const driverDisplayName = driverValue
          ? driverMeta?.text || driverValue
          : null;
        const callManagerValue = callManagerNode
          ? callManagerNode.textContent.trim()
          : "";
        const journeyNumberValue = numberHint || null;
        return {
          departure_date:
            document.getElementById("departure-date")?.value || null,
          vehicle_number:
            document.getElementById("vehicle-number")?.value || null,
          vehicle_display_name: (function () {
            if (!vehicleNumberSelect) return null;
            const opt =
              vehicleNumberSelect.options[
                vehicleNumberSelect.selectedIndex
              ];
            return opt?.dataset.displayName || opt?.textContent || null;
          })(),
          driver_name: driverDisplayName,
          from_location: selectedText(fromSel) || fromSel?.value || null,
          from_departure_time: fromTime?.value || null,
          to_location: selectedText(toSel) || toSel?.value || null,
          to_arrival_time: toTime?.value || null,
          call_journey_manager: callManagerValue || null,
          signature_date:
            document.getElementById("departure-date")?.value || null,
          journey_plan_number_hint: journeyNumberValue,
          passengers,
          rest_stops: restStops,
          route_snapshot: {
            journey_plan_number_hint: numberHint,
            driver: driverMeta
              ? {
                  value: driverMeta.value,
                  name: driverMeta.text,
                  code: driverMeta.code,
                  gsm: driverMeta.gsm,
                }
              : null,
            rows: routeRows,
          },
          notes: null,
        };
      }

      async function saveJourneyPlan() {
        if (!saveButton) return;

        // Validation: التحقق من الحقول الإجبارية
        const validationErrors = [];

        // اسم السائق
        if (!driverSelect?.value) {
          validationErrors.push("Driver name is required");
        }

        // رقم المركبة
        if (!vehicleNumberSelect?.value) {
          validationErrors.push("Vehicle number is required");
        }

        // تاريخ المغادرة
        if (!departureDateInput?.value) {
          validationErrors.push("Departure date is required");
        }

        // From: مكان + وقت
        if (!fromSel?.value) {
          validationErrors.push("From location is required");
        }
        if (!fromTime?.value) {
          validationErrors.push("From departure time is required");
        }

        // To: مكان + وقت
        if (!toSel?.value) {
          validationErrors.push("To location is required");
        }
        if (!toTime?.value) {
          validationErrors.push("To arrival time is required");
        }

        // عرض الأخطاء إن وجدت
        if (validationErrors.length > 0) {
          const errorMessage =
            "Please fill required fields:\n\n• " +
            validationErrors.join("\n• ");
          alert(errorMessage);
          setStatus(
            "Validation failed. Please check required fields.",
            "error"
          );
          return;
        }

        try {
          setStatus("Saving journey plan...");
          saveButton.disabled = true;
          const payload = collectJourneyPlanData();
          const response = await authFetch(
            `${window.API_BASE || ""}/api/journey-plans`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            let message = "Failed to save journey plan.";
            try {
              const err = await response.json();
              if (err?.error) message = err.error;
            } catch {
              // ignore parse errors
            }
            throw new Error(message);
          }

          const { data } = await response.json();
          if (data?.journey_plan_number && journeyNumberNode) {
            journeyNumberNode.textContent = data.journey_plan_number;
            journeyNumberNode.dataset.locked = "true";
          }
          setStatus("Journey plan saved successfully.", "success");

          // فتح template.html للطباعة
          printToTemplatePage();
        } catch (error) {
          console.error("Error saving journey plan", error);
          setStatus(error.message || "Failed to save journey plan.", "error");
        } finally {
          saveButton.disabled = false;
        }
      }

      function applyRestDisplay(slot, nameText, arriveVal, departVal) {
        if (!slot || slot > 10) return;
        setRoutePlaceName(slot, nameText);
        setArrive(slot, normalizeTimeValue(arriveVal));
        setDepart(slot, normalizeTimeValue(departVal));
        if (slot >= 2 && slot <= 10) {
          setRestTick(slot, calculateRestTick(arriveVal, departVal));
        }
      }

      function renderToRow() {
        const fields = restFields();
        const occupiedSlots = new Set();
        let maxRestSlot = 1;
        fields.forEach((field) => {
          const slot = Number(field.dataset.restSlot);
          if (!Number.isNaN(slot) && slot > 0) {
            occupiedSlots.add(slot);
            if (slot > maxRestSlot) maxRestSlot = slot;
          }
        });
        if (occupiedSlots.size === 0) {
          maxRestSlot = 1;
        }
        const toSlot = Math.min(10, Math.max(2, maxRestSlot + 1));
        const toName = selectedText(toSel) || (toSel ? toSel.value : "");
        const toArrive = normalizeTimeValue(toTime && toTime.value);
        const defaultDepart = toArrive ? "00:00" : "";

        for (let idx = 2; idx <= 10; idx++) {
          if (occupiedSlots.has(idx)) continue;

          if (idx === toSlot) {
            setRoutePlaceName(idx, toName);
            setArrive(idx, toArrive);
            setDepart(idx, defaultDepart);
          } else {
            setRoutePlaceName(idx, "");
            setArrive(idx, "");
            setDepart(idx, "");
            if (idx >= 2 && idx <= 10) {
              setRestTick(idx, "");
            }
          }
        }
      }

      function reindexRestSlots() {
        if (!restsContainer) return;
        const fields = restFields();

        for (let idx = 2; idx <= 9; idx++) {
          setRoutePlaceName(idx, "");
          setArrive(idx, "");
          setDepart(idx, "");
          if (idx >= 2) {
            setRestTick(idx, "");
          }
        }

        fields.forEach((field, index) => {
          const slot = index + 2;
          field.dataset.restSlot = String(slot);

          const label = field.querySelector("[data-rest-label]");
          if (label) label.textContent = `Rest ${index + 1}`;

          const nameSel = field.querySelector("select[data-rest-name]");
          const inArr = field.querySelector("input[data-rest-arrive]");
          const inDep = field.querySelector("input[data-rest-depart]");

          if (nameSel) nameSel.dataset.restNameIndex = String(slot);
          if (inArr) inArr.dataset.restIndex = String(slot);
          if (inDep) inDep.dataset.restIndex = String(slot);

          const nameText =
            nameSel && nameSel.value ? selectedText(nameSel) : "";
          const arriveVal = inArr ? inArr.value : "";
          const departVal = inDep ? inDep.value : "";
          applyRestDisplay(slot, nameText, arriveVal, departVal);
        });

        for (let n = fields.length + 2; n <= 10; n++) {
          setRestTick(n, "");
        }

        renderToRow();
        syncRestAddButton();
      }

      function createRestField() {
        const wrap = document.createElement("div");
        wrap.style.display = "flex";
        wrap.style.gap = "6px";
        wrap.style.alignItems = "center";
        wrap.className = "rest-field";
        wrap.dataset.restSlot = "0";

        const label = document.createElement("label");
        label.setAttribute("data-rest-label", "");
        label.style.minWidth = "105px";
        label.textContent = "Rest";

        const nameWrapper = document.createElement("div");
        nameWrapper.className = "select-with-add";

        const nameSel = document.createElement("select");
        nameSel.setAttribute("data-rest-name", "");
        nameSel.dataset.placeholder = "Select rest name";
        nameSel.style.minWidth = "150px";
        nameSel.innerHTML = `<option value="">Select rest name</option>${REST_NAME_OPTIONS_HTML}`;

        const addName = document.createElement("button");
        addName.type = "button";
        addName.textContent = "+";
        addName.title = "Add rest name";
        addName.className = "select-add-btn";
        addName.addEventListener("click", async () => {
          let label = prompt("Enter rest name");
          if (label === null) return;
          label = String(label).trim();
          if (!label) return;

          // حفظ في الداتابيز
          try {
            const response = await authFetch(
              `${window.API_BASE || ""}/api/options/rest-types`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: label }),
              }
            );

            if (!response.ok) {
              const err = await response.json().catch(() => ({}));
              alert(err.error || "Failed to save rest type");
              return;
            }
          } catch (error) {
            console.error("Error saving rest type:", error);
            alert("Failed to save rest type to database");
            return;
          }

          const opt = new Option(label, label);
          nameSel.add(opt);
          nameSel.value = label;
          nameSel.dispatchEvent(new Event("change", { bubbles: true }));
        });

        nameWrapper.appendChild(nameSel);
        nameWrapper.appendChild(addName);

        const inArr = document.createElement("input");
        inArr.type = "time";
        inArr.placeholder = "Arrive";
        inArr.setAttribute("data-rest-arrive", "");

        const inDep = document.createElement("input");
        inDep.type = "time";
        inDep.placeholder = "Depart";
        inDep.setAttribute("data-rest-depart", "");

        const getSlot = () => Number(wrap.dataset.restSlot) || 0;

        function applyCurrentState() {
          const slot = getSlot();
          if (!slot) return;
          const nameText = nameSel.value ? selectedText(nameSel) : "";
          applyRestDisplay(slot, nameText, inArr.value, inDep.value);
          renderToRow();
        }

        nameSel.addEventListener("change", applyCurrentState);
        inArr.addEventListener("change", applyCurrentState);
        inDep.addEventListener("change", applyCurrentState);

        const del = document.createElement("button");
        del.type = "button";
        del.textContent = "×";
        del.style.cssText =
          "padding:2px 6px;border:1px solid #ccc;background:#eee;border-radius:4px;cursor:pointer;font-size:16px;line-height:1;";
        del.addEventListener("click", () => {
          wrap.remove();
          reindexRestSlots();
        });

        wrap.appendChild(label);
        wrap.appendChild(nameWrapper);
        wrap.appendChild(inArr);
        wrap.appendChild(inDep);
        wrap.appendChild(del);
        return wrap;
      }

      if (addRestBtn && restsContainer) {
        addRestBtn.addEventListener("click", () => {
          if (currentRests() >= 8) return;
          restsContainer.appendChild(createRestField());
          reindexRestSlots();
        });
      }

      if (saveButton) {
        saveButton.addEventListener("click", saveJourneyPlan);
      }

      if (refreshNumberButton) {
        refreshNumberButton.addEventListener("click", async () => {
          if (journeyNumberNode) journeyNumberNode.dataset.locked = "false";
          const next = await fetchNextJourneyPlanNumber();
          if (next) {
            setStatus(`Next journey plan number: ${next}`, "success");
          }
        });
      }

      reindexRestSlots();
      renderToRow();
      if (applyDriverHandler) applyDriverHandler();
      refreshPeopleOptions();
      fetchNextJourneyPlanNumber();

      // ===== Load & Search Journeys (Autocomplete) =====
      let allJourneys = [];
      const loadJourneySearch = document.getElementById("load-journey-search");
      const journeySuggestions = document.getElementById("journey-suggestions");

      async function fetchAllJourneys() {
        try {
          const response = await authFetch(
            `${window.API_BASE || ""}/api/journey-plans`
          );
          if (!response.ok) throw new Error("Failed to fetch journeys");
          const { data } = await response.json();
          allJourneys = data || [];
        } catch (error) {
          console.error("Error fetching journeys:", error);
        }
      }

      function showSuggestions(journeys) {
        if (!journeySuggestions) return;

        if (journeys.length === 0) {
          journeySuggestions.style.display = "none";
          return;
        }

        journeySuggestions.innerHTML = "";
        journeySuggestions.style.display = "block";

        journeys.slice(0, 10).forEach((journey) => {
          const item = document.createElement("div");
          item.style.cssText = `
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid rgba(48, 43, 184, 0.08);
            transition: background 0.2s;
          `;

          const date = journey.departure_date
            ? new Date(journey.departure_date).toLocaleDateString()
            : "N/A";

          item.innerHTML = `
            <div style="font-weight: 600; color: #302bb8;">#${
              journey.journey_plan_number
            }</div>
            <div style="font-size: 13px; color: #666;">
              ${journey.driver_name || "No driver"} | ${
            journey.from_location || ""
          } → ${journey.to_location || ""} | ${date}
            </div>
          `;

          item.dataset.journeyData = JSON.stringify(journey);

          item.addEventListener("mouseenter", () => {
            item.style.background = "rgba(48, 43, 184, 0.08)";
          });

          item.addEventListener("mouseleave", () => {
            item.style.background = "transparent";
          });

          item.addEventListener("click", () => {
            try {
              const journeyData = JSON.parse(item.dataset.journeyData);
              loadJourneyToForm(journeyData);
              loadJourneySearch.value = "";
              journeySuggestions.style.display = "none";
            } catch (error) {
              console.error("Error loading journey:", error);
              setStatus("Failed to load journey", "error");
            }
          });

          journeySuggestions.appendChild(item);
        });
      }

      // Live search
      if (loadJourneySearch) {
        loadJourneySearch.addEventListener("input", (e) => {
          const searchTerm = e.target.value.toLowerCase().trim();

          if (!searchTerm || searchTerm.length < 1) {
            journeySuggestions.style.display = "none";
            return;
          }

          const filtered = allJourneys.filter((journey) => {
            const searchText = [
              journey.journey_plan_number?.toString(),
              journey.driver_name,
              journey.vehicle_number,
              journey.from_location,
              journey.to_location,
              journey.departure_date,
            ]
              .filter(Boolean)
              .join(" ")
              .toLowerCase();

            return searchText.includes(searchTerm);
          });

          showSuggestions(filtered);
        });

        // إخفاء suggestions عند الضغط خارجها
        document.addEventListener("click", (e) => {
          if (
            !loadJourneySearch.contains(e.target) &&
            !journeySuggestions.contains(e.target)
          ) {
            journeySuggestions.style.display = "none";
          }
        });
      }

      function loadJourneyToForm(journeyData) {
        // ملء الحقول الأساسية
        if (departureDateInput && journeyData.departure_date) {
          departureDateInput.value = journeyData.departure_date;
          departureDateInput.dispatchEvent(new Event("change"));
        }

        if (vehicleNumberSelect && journeyData.vehicle_number) {
          vehicleNumberSelect.value = journeyData.vehicle_number;
          vehicleNumberSelect.dispatchEvent(new Event("change"));
        }

        if (driverSelect && journeyData.driver_name) {
          // البحث عن السائق في القائمة
          const driverOption = Array.from(driverSelect.options).find(
            (opt) => opt.textContent.trim() === journeyData.driver_name
          );
          if (driverOption) {
            driverSelect.value = driverOption.value;
          } else {
            // إضافة السائق إذا لم يكن موجود
            const newOption = new Option(
              journeyData.driver_name,
              journeyData.driver_name
            );
            driverSelect.add(newOption);
            driverSelect.value = journeyData.driver_name;
          }
          driverSelect.dispatchEvent(new Event("change"));
        }

        if (fromSel && journeyData.from_location) {
          fromSel.value = journeyData.from_location;
          fromSel.dispatchEvent(new Event("change"));
        }

        if (fromTime && journeyData.from_departure_time) {
          fromTime.value = journeyData.from_departure_time;
          fromTime.dispatchEvent(new Event("change"));
        }

        if (toSel && journeyData.to_location) {
          toSel.value = journeyData.to_location;
          toSel.dispatchEvent(new Event("change"));
        }

        if (toTime && journeyData.to_arrival_time) {
          toTime.value = journeyData.to_arrival_time;
          toTime.dispatchEvent(new Event("change"));
        }

        // ملء الركاب
        if (journeyData.passengers && Array.isArray(journeyData.passengers)) {
          // مسح الركاب الحاليين
          container.innerHTML = "";

          journeyData.passengers.forEach((passenger, index) => {
            const field = createPassengerField(index + 1);
            container.appendChild(field);
            const select = field.querySelector("select[data-passenger-index]");
            if (select && passenger.value) {
              // إضافة الراكب إذا لم يكن موجود
              const existingOption = Array.from(select.options).find(
                (opt) => opt.value === passenger.value
              );
              if (!existingOption && passenger.name) {
                const newOption = new Option(passenger.name, passenger.value);
                select.add(newOption);
              }
              select.value = passenger.value;
              select.dispatchEvent(new Event("change"));
            }
          });

          if (journeyData.passengers.length >= 3) {
            addBtn.style.display = "none";
          }
        }

        // ملء Rest stops
        if (journeyData.rest_stops && Array.isArray(journeyData.rest_stops)) {
          // مسح Rest stops الحالية
          restsContainer.innerHTML = "";

          journeyData.rest_stops.forEach((rest) => {
            const field = createRestField();
            restsContainer.appendChild(field);

            const nameSelect = field.querySelector("select[data-rest-name]");
            const arriveInput = field.querySelector("input[data-rest-arrive]");
            const departInput = field.querySelector("input[data-rest-depart]");

            if (nameSelect && rest.name) {
              const existingOption = Array.from(nameSelect.options).find(
                (opt) => opt.value === rest.name
              );
              if (!existingOption) {
                const newOption = new Option(rest.name, rest.name);
                nameSelect.add(newOption);
              }
              nameSelect.value = rest.name;
              nameSelect.dispatchEvent(new Event("change"));
            }

            if (arriveInput && rest.arrive_time) {
              arriveInput.value = rest.arrive_time;
              arriveInput.dispatchEvent(new Event("change"));
            }

            if (departInput && rest.depart_time) {
              departInput.value = rest.depart_time;
              departInput.dispatchEvent(new Event("change"));
            }
          });

          reindexRestSlots();
        }

        // تحديث رقم Journey Plan
        if (journeyNumberNode && journeyData.journey_plan_number) {
          journeyNumberNode.textContent = journeyData.journey_plan_number;
          journeyNumberNode.dataset.loaded = "true";
        }

        setStatus("Journey loaded successfully", "success");
      }

      // Note: Load button removed - journeys load on click from suggestions

      // تحميل قائمة الـ Journeys عند بدء الصفحة
      fetchAllJourneys();

      // تحميل Journey من URL parameter (من Dashboard)
      const urlParams = new URLSearchParams(window.location.search);
      const loadNumber = urlParams.get("load");
      if (loadNumber) {
        // انتظار تحميل القائمة ثم تحميل Journey المطلوب
        setTimeout(async () => {
          const journey = allJourneys.find(
            (j) => j.journey_plan_number == loadNumber
          );
          if (journey) {
            loadJourneyToForm(journey);
          } else {
            // محاولة تحميله من API مباشرة
            try {
              const response = await authFetch(
                `${window.API_BASE || ""}/api/journey-plans`
              );
              const { data } = await response.json();
              const foundJourney = data?.find(
                (j) => j.journey_plan_number == loadNumber
              );
              if (foundJourney) {
                loadJourneyToForm(foundJourney);
              }
            } catch (error) {
              console.error("Failed to load journey:", error);
            }
          }
        }, 1000);
      }

      // ===== Update & New Journey Functions =====
      const updateButton = document.getElementById("update-journey-plan");
      const newJourneyButton = document.getElementById("new-journey-plan");
      let currentLoadedJourneyNumber = null;

      function switchToEditMode(journeyNumber) {
        currentLoadedJourneyNumber = journeyNumber;

        // إخفاء Save، إظهار Update و New
        if (saveButton) saveButton.style.display = "none";
        if (updateButton) updateButton.style.display = "block";
        if (newJourneyButton) newJourneyButton.style.display = "block";

        setStatus(`Editing Journey #${journeyNumber}`, "success");
      }

      function switchToNewMode() {
        currentLoadedJourneyNumber = null;

        // إظهار Save، إخفاء Update و New
        if (saveButton) saveButton.style.display = "block";
        if (updateButton) updateButton.style.display = "none";
        if (newJourneyButton) newJourneyButton.style.display = "none";

        // مسح جميع الحقول
        clearAllFields();

        // إعادة تحميل رقم Journey Plan التالي
        if (journeyNumberNode) {
          journeyNumberNode.dataset.loaded = "false";
          journeyNumberNode.dataset.locked = "false";
        }
        fetchNextJourneyPlanNumber();

        setStatus("Ready for new journey", "success");
      }

      function clearAllFields() {
        if (departureDateInput) departureDateInput.value = "";
        if (vehicleNumberSelect) vehicleNumberSelect.value = "";
        if (driverSelect) driverSelect.value = "";
        if (fromSel) fromSel.value = "";
        if (fromTime) fromTime.value = "";
        if (toSel) toSel.value = "";
        if (toTime) toTime.value = "";

        if (container) container.innerHTML = "";
        if (restsContainer) restsContainer.innerHTML = "";
        if (addBtn) addBtn.style.display = "inline-block";

        renderFromRow();
        renderToRow();
        if (applyDriverHandler) applyDriverHandler();
      }

      async function updateJourneyPlan() {
        if (!currentLoadedJourneyNumber) {
          alert("No journey loaded for update");
          return;
        }

        // نفس الـ validation
        const validationErrors = [];

        if (!driverSelect?.value)
          validationErrors.push("Driver name is required");
        if (!vehicleNumberSelect?.value)
          validationErrors.push("Vehicle number is required");
        if (!departureDateInput?.value)
          validationErrors.push("Departure date is required");
        if (!fromSel?.value) validationErrors.push("From location is required");
        if (!fromTime?.value)
          validationErrors.push("From departure time is required");
        if (!toSel?.value) validationErrors.push("To location is required");
        if (!toTime?.value)
          validationErrors.push("To arrival time is required");

        if (validationErrors.length > 0) {
          alert(
            "Please fill required fields:\n\n• " + validationErrors.join("\n• ")
          );
          setStatus("Validation failed", "error");
          return;
        }

        try {
          setStatus("Updating journey plan...");
          updateButton.disabled = true;

          const payload = collectJourneyPlanData();
          const response = await authFetch(
            `${
              window.API_BASE || ""
            }/api/journey-plans/${currentLoadedJourneyNumber}`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(payload),
            }
          );

          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.error || "Failed to update journey plan");
          }

          const { data } = await response.json();
          setStatus("Journey plan updated successfully!", "success");

          // إعادة تحميل القائمة
          await fetchAllJourneys();

          // فتح template للطباعة
          printToTemplatePage();
        } catch (error) {
          console.error("Error updating journey plan:", error);
          setStatus(error.message || "Failed to update journey plan", "error");
        } finally {
          if (updateButton) updateButton.disabled = false;
        }
      }

      if (updateButton) {
        updateButton.addEventListener("click", updateJourneyPlan);
      }

      if (newJourneyButton) {
        newJourneyButton.addEventListener("click", switchToNewMode);
      }

      // تعديل loadJourneyToForm لتفعيل Edit mode
      const originalLoadJourneyToForm = loadJourneyToForm;
      loadJourneyToForm = function (journeyData) {
        originalLoadJourneyToForm(journeyData);
        switchToEditMode(journeyData.journey_plan_number);
      };

      // ===== دالة الطباعة باستخدام template.html =====
      function printToTemplatePage() {
        // جمع كل البيانات من الصفحة الحالية
        const printData = {
          journeyPlanNumber: journeyNumberNode?.textContent || "",
          departureDate:
            document.querySelector(".Departure-Date")?.textContent || "",
          vehicleNumber:
            document.querySelector(".Vehicle-Number")?.textContent || "",
          driverName: document.querySelector(".Driver-Name")?.textContent || "",
          callManager: callManagerNode?.textContent || "",
          signatureDate: signatureDateNode?.textContent || "",
          passengers: [],
          routes: [],
          times: [],
          rests: [],
        };

        // الركاب
        for (let i = 1; i <= 3; i++) {
          const passenger = document.querySelector(`.Passengers-${i}`);
          if (passenger) {
            printData.passengers.push(passenger.innerHTML);
          }
        }

        // المسارات والأوقات والراحة
        for (let i = 1; i <= 10; i++) {
          const route =
            document.querySelector(`.Route-Place-Name-${i}`)?.textContent || "";
          const time =
            document.querySelector(`.Time-Arrive-Time-Depart-${i}`)
              ?.innerHTML || "";
          const rest =
            document.querySelector(`.Rest-Tick-${i}`)?.textContent || "";

          printData.routes.push(route);
          printData.times.push(time);
          printData.rests.push(rest);
        }

        // حفظ البيانات في localStorage
        localStorage.setItem("journeyPlanPrintData", JSON.stringify(printData));

        // فتح template.html
        const printWindow = window.open(
          "template.html",
          "_blank",
          "width=1200,height=800"
        );

        if (!printWindow) {
          alert("Please allow pop-ups to print the journey plan");
          return;
        }
      }
    })();
  } else {
    window.location.href = "change-password.html";
  }
  </script>
</html>
